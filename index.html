<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²´ìŠ¤ ë§ˆë¸” - ë ˆì´ì‹± ì—ë””ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #000000;
            background-image: 
                linear-gradient(45deg, #111 25%, transparent 25%), 
                linear-gradient(-45deg, #111 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #111 75%), 
                linear-gradient(-45deg, transparent 75%, #111 75%);
            background-size: 80px 80px;
            background-position: 0 0, 0 40px, 40px -40px, -40px 0px;
            color: #f8fafc;
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        .nav-bar {
            width: 100%; 
            height: 65px; 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 200;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(251, 191, 36, 0.1);
        }

        .nav-content { height: 100%; max-width: 1400px; margin: 0 auto; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; }
        .nav-logo { font-weight: 900; font-size: 1rem; color: #fbbf24; letter-spacing: -1px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        
        .nav-right-area { display: flex; gap: 12px; align-items: center; }
        .nav-links { display: flex; gap: 8px; align-items: center; }
        
        .nav-link { 
            font-size: 10px; 
            font-weight: 700; 
            color: #fbbf24; 
            cursor: pointer; 
            transition: all 0.2s; 
            white-space: nowrap;
            padding: 5px 12px;
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            background: rgba(251, 191, 36, 0.05);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 24px;
        }

        .game-top-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 75px;
            z-index: 250;
            display: none;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.95), transparent);
            padding: 10px 16px;
        }
        .dashboard-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 16px;
            display: flex;
            align-items: center;
            padding: 8px 16px;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .db-stat { display: flex; flex-direction: column; align-items: center; min-width: 40px; }
        .db-label { font-size: 8px; font-weight: 900; color: rgba(251, 191, 36, 0.6); text-transform: uppercase; }
        .db-value { font-size: 11px; font-weight: 900; color: #fff; }

        .overlay-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(251, 191, 36, 0.4);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 25px;
        }

        .dice-overlay {
            position: fixed;
            inset: 0;
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            pointer-events: none;
        }

        .dice-container { width: 120px; height: 120px; perspective: 1000px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cube-face {
            position: absolute;
            width: 120px;
            height: 120px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(8px);
            border: 4px solid rgba(251, 191, 36, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            font-weight: 900;
            color: #fbbf24;
            border-radius: 16px;
        }
        .front  { transform: rotateY(0deg) translateZ(60px); }
        .back   { transform: rotateY(180deg) translateZ(60px); }
        .right  { transform: rotateY(90deg) translateZ(60px); }
        .left   { transform: rotateY(-90deg) translateZ(60px); }
        .top    { transform: rotateX(90deg) translateZ(60px); }
        .bottom { transform: rotateX(-90deg) translateZ(60px); }
        .rolling { animation: cubeRotate 0.4s linear infinite; }
        @keyframes cubeRotate { 0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); } 100% { transform: rotateX(360deg) rotateY(360deg) rotateZ(360deg); } }

        .home-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; perspective: 1000px; padding: 20px; }
        .spade-card {
            width: 100%;
            max-width: 280px;
            height: 400px;
            background: #ffffff;
            border-radius: 15px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.1);
            animation: cardFloat 4s ease-in-out infinite;
            padding: 20px;
            border: 1px solid #ddd;
        }
        @keyframes cardFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(1deg); } }
        
        .card-corner { position: absolute; display: flex; flex-direction: column; align-items: center; color: #1a1a1a; font-weight: 900; line-height: 1; }
        .corner-top { top: 15px; left: 15px; }
        .corner-bottom { bottom: 15px; right: 15px; transform: rotate(180deg); }
        .corner-rank { font-size: 24px; }
        .corner-suit { font-size: 18px; }

        .spade-center-icon { font-size: 80px; color: #1a1a1a; margin-bottom: 15px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        
        .spade-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #nickname-input {
            background: rgba(251, 191, 36, 0.05);
            border: 3px solid #fbbf24; 
            color: #000;
        }
        .btn-gold-start {
            background: linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #d97706 100%);
            color: #000;
            text-shadow: 0 1px 0 rgba(255,255,255,0.4);
            border: 3px solid #78350f; 
            box-shadow: 0 4px 0 #78350f, 0 8px 15px rgba(180, 83, 9, 0.4);
        }

        .mode-card {
            background: #0f172a; 
            border: 2px solid rgba(251, 191, 36, 0.3);
            transition: all 0.3s;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .mode-card:hover {
            background: #1e293b;
            border-color: #fbbf24;
            transform: translateY(-5px);
        }

        .board-container { 
            perspective: 2000px; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); 
        }
        
        .dice-board { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            grid-template-rows: repeat(7, 1fr); 
            gap: 2%; 
            width: 80vw; 
            max-width: 480px; 
            aspect-ratio: 1/1; 
            transform: rotateX(50deg) rotateZ(-45deg); 
            transform-style: preserve-3d; 
            position: relative;
        }

        .tile { 
            aspect-ratio: 1/1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%); 
            border: 1px solid rgba(251, 191, 36, 0.4);
            border-radius: 6px; 
            font-weight: 900; 
            font-size: 0.65rem; 
            position: relative; 
            box-shadow: 0px 3px 0px 0px #78350f, 0px 6px 10px rgba(0,0,0,0.6);
            color: #fbbf24;
            transform-style: preserve-3d; 
            transform: translateZ(10px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @media (min-width: 641px) {
            .tile { font-size: 0.8rem; border-radius: 8px; }
        }

        .tile-penalty { border: 2px solid #ef4444; color: #ef4444; }
        .tile-bonus { border: 2px solid #22c55e; color: #22c55e; }
        .tile-battle { border: 2px solid #ef4444; color: #ffffff; background: rgba(239, 68, 68, 0.8); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .tile.empty-space { background: transparent; border: none; box-shadow: none; color: transparent; pointer-events: none; }

        .center-status-bubble { grid-area: 3/3 / 6/6; display: flex; align-items: center; justify-content: center; z-index: 10; pointer-events: none; transform-style: preserve-3d; }
        .status-content {
            background: #0f172a; color: #fbbf24; padding: 8px 12px; border-radius: 10px; font-weight: 900; font-size: 10px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); transform: translateZ(60px) rotateZ(45deg) rotateX(-50deg); border: 2px solid #fbbf24;
            white-space: nowrap;
        }
        @media (min-width: 641px) {
            .status-content { padding: 10px 18px; font-size: 13px; }
        }

        .game-controls-mini { 
            position: fixed; 
            bottom: 25px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 90%; 
            max-width: 500px; 
            padding: 10px 18px; 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            z-index: 160; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(20px); 
            border: 2px solid #fbbf24; 
        }
        .dice-box { width: 50px; height: 50px; background: linear-gradient(135deg, #fbbf24, #d97706); border: 2px solid #fde68a; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 900; color: #020617; cursor: pointer; box-shadow: 0 6px 0 #b45309; transition: all 0.1s; }

        .compact-profile { width: 100px; padding: 6px; border-radius: 12px; background: rgba(0, 0, 0, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); }
        @media (min-width: 641px) {
            .compact-profile { width: 120px; padding: 8px; }
        }
        .compact-profile.active-turn { border-color: #fbbf24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        .chess-piece { position: absolute; width: 100%; height: 100%; z-index: 150; transform: translateZ(40px) rotateZ(45deg) rotateX(-50deg) scale(1.3); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; display: flex; align-items: center; justify-content: center; }
        @media (min-width: 641px) {
            .chess-piece { transform: translateZ(50px) rotateZ(45deg) rotateX(-50deg) scale(1.5); }
        }
        .chess-svg { width: 100%; height: 100%; filter: drop-shadow(0 15px 10px rgba(0,0,0,0.7)); }

        .item-badge { width: 18px; height: 18px; border-radius: 5px; background: #1e293b; border: 1px solid #fbbf24; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; }
        .item-count { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 8px; padding: 1px 3px; border-radius: 10px; font-weight: 900; }

        .hidden { display: none !important; }

        .ranking-item { 
            padding: 10px 12px; 
            background: rgba(30, 41, 59, 0.7); 
            border: 1px solid rgba(251, 191, 36, 0.2); 
            border-radius: 12px; 
            display: grid;
            grid-template-columns: 35px 70px 1fr 50px 70px;
            align-items: center; 
            gap: 6px; 
            margin-bottom: 8px; 
        }

        .ranking-tier-badge { font-size: 7px; font-weight: 900; padding: 2px 4px; border-radius: 4px; text-transform: uppercase; border-width: 1px; border-style: solid; }
        .tier-diamond { background: rgba(34, 211, 238, 0.2); color: #22d3ee; border-color: #22d3ee; }
        .tier-gold { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border-color: #fbbf24; }
        .tier-silver { background: rgba(148, 163, 184, 0.2); color: #94a3b8; border-color: #94a3b8; }
        .tier-bronze { background: rgba(180, 83, 9, 0.2); color: #b45309; border-color: #b45309; }

        .ranking-header {
            display: grid; grid-template-columns: 35px 70px 1fr 50px 70px; gap: 6px; padding: 0 12px 10px 12px; border-bottom: 1px solid rgba(251, 191, 36, 0.2); margin-bottom: 10px; font-size: 8px; font-weight: 900; color: rgba(251, 191, 36, 0.5); text-align: center;
        }

        .matching-loader { width: 60px; height: 60px; border: 4px solid #fbbf24; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(251, 191, 36, 0.3); border-radius: 10px; }
    </style>
</head>
<body oncontextmenu="return false" onselectstart="return false" ondragstart="return false">

    <div id="dice-overlay" class="dice-overlay">
        <div class="dice-container">
            <div id="cube" class="cube">
                <div class="cube-face front">1</div><div class="cube-face back">6</div><div class="cube-face right">3</div><div class="cube-face left">4</div><div class="cube-face top">2</div><div class="cube-face bottom">5</div>
            </div>
        </div>
    </div>

    <header id="top-nav" class="nav-bar">
        <div class="nav-content">
            <div class="nav-logo" onclick="location.reload()">
                <div class="w-8 h-8 bg-amber-400 rounded-lg flex items-center justify-center text-black font-black">C</div>
                <span>ì²´ìŠ¤ ë§ˆë¸”</span>
            </div>
            <div class="nav-right-area">
                <div class="nav-links">
                    <span class="nav-link" onclick="openRanking()">ë§ˆë¸” ë­í‚¹</span>
                    <span class="nav-link" onclick="toggleModal('patch-modal')">íŒ¨ì¹˜ë…¸íŠ¸</span>
                </div>
            </div>
        </div>
    </header>

    <div id="game-dashboard" class="game-top-dashboard">
        <div class="dashboard-container">
            <div class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center bg-amber-400/20 border border-amber-400/40 rounded-xl text-lg sm:text-xl">ğŸ“€</div>
            <div class="flex flex-col flex-1">
                <div class="flex items-center gap-2">
                    <span id="db-name" class="font-black text-xs sm:text-sm text-white">í”Œë ˆì´ì–´</span>
                    <span id="db-mode-badge" class="bg-amber-400 text-black text-[7px] sm:text-[8px] px-1 py-0.5 sm:px-1.5 rounded font-black uppercase">CLASSIC</span>
                </div>
                <div class="flex gap-3 sm:gap-4 mt-0.5 sm:mt-1">
                    <div class="db-stat"><span class="db-label">ìˆœìœ„</span><span class="db-value">#1</span></div>
                    <div class="db-stat"><span class="db-label">ìŠ¹ë¥ </span><span class="db-value">100%</span></div>
                    <div class="db-stat"><span class="db-label">ëª¨ë“œ</span><span id="db-mode-text" class="db-value text-amber-400">ì¸ê³µì§€ëŠ¥</span></div>
                </div>
            </div>
            <div id="db-inventory" class="hidden sm:flex gap-1.5 border-l border-white/10 pl-4"></div>
        </div>
    </div>

    <!-- Modals (Shop, Resign, Ranking, Patch) remain unchanged -->
    <div id="shop-modal" class="overlay-modal" onclick="event.target === this && toggleModal('shop-modal')">
        <div class="modal-content">
            <h3 class="text-xl font-black text-amber-400 italic mb-6">ì•„ì´í…œ ìƒì </h3>
            <div class="scroll-area space-y-3 overflow-y-auto">
                <div class="p-4 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-amber-400/20 rounded-xl flex items-center justify-center text-xl">ğŸ›¡ï¸</div>
                        <div><div class="font-black text-sm text-white">ë²Œì¹™ì¹¸ ì‰´ë“œ</div><div class="text-[9px] text-white/40">í›„í‡´ ë°©ì§€</div></div>
                    </div>
                    <button onclick="buyItem('shield')" class="bg-amber-400 text-black font-black text-xs px-4 py-2 rounded-lg">ë¬´ë£Œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="resign-modal" class="overlay-modal">
        <div class="modal-content text-center">
            <h3 class="text-xl font-black text-red-500 italic mb-2">ì •ë§ ê¸°ê¶Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p class="text-xs text-white/60 mb-8 leading-relaxed">ê¸°ê¶Œ ì‹œ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ íŒ¨ë°° ì²˜ë¦¬ë˜ë©° ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            <div class="flex gap-3">
                <button onclick="toggleModal('resign-modal')" class="flex-1 bg-white/10 text-white font-black py-3 rounded-xl">ê³„ì†í•˜ê¸°</button>
                <button onclick="handleResign()" class="flex-1 bg-red-500 text-white font-black py-3 rounded-xl">ê¸°ê¶Œ í™•ì •</button>
            </div>
        </div>
    </div>

    <div id="ranking-modal" class="overlay-modal">
        <div class="modal-content max-w-[600px]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg sm:text-xl font-black text-amber-400 italic">ë§ˆë¸” ë­í‚¹ TOP 400</h3>
                <button onclick="toggleModal('ranking-modal')" class="text-white/40 hover:text-white transition-colors">âœ•</button>
            </div>
            <div class="ranking-header"><span>ìˆœìœ„</span><span>ê³„ê¸‰ì¥</span><span class="text-left">ë‹‰ë„¤ì„</span><span>ìŠ¹ë¥ </span><span class="text-right">ì ìˆ˜</span></div>
            <div id="ranking-list" class="overflow-y-auto pr-2 custom-scrollbar"></div>
        </div>
    </div>

    <div id="patch-modal" class="overlay-modal" onclick="event.target === this && toggleModal('patch-modal')">
        <div class="modal-content">
            <h3 class="text-xl font-black text-amber-400 italic mb-6">íŒ¨ì¹˜ ë…¸íŠ¸</h3>
            <div class="text-xs text-white/50 leading-loose">
                v3.2.0: ë§ˆë¸” ì „íˆ¬ ëª¨ë“œ ì—…ë°ì´íŠ¸<br>
                - ì „íˆ¬ ëª¨ë“œ ì„ íƒ ì‹œ ë³´ë“œì— ëœë¤ ì „íˆ¬ ì¹¸ ìƒì„±<br>
                - ì „íˆ¬ ì¹¸ ë„ì°© ì‹œ ìƒëŒ€ë¥¼ 1ì¹¸ ë’¤ë¡œ ë„‰ë°±<br>
                - ì „íˆ¬ ëª¨ë“œ í™œì„±í™” ì‹œ ì •ë³´ í‘œì‹œ ìµœì í™”
            </div>
        </div>
    </div>

    <div id="home-screen" class="home-container">
        <div class="spade-card">
            <div class="card-corner corner-top"><div class="corner-rank">A</div><div class="corner-suit">â™ </div></div>
            <div class="card-corner corner-bottom"><div class="corner-rank">A</div><div class="corner-suit">â™ </div></div>
            <div class="spade-center-icon">â™ </div>
            <div class="spade-content">
                <h2 class="text-2xl font-black italic text-black mb-1">ì²´ìŠ¤ ë ˆì´ìŠ¤</h2>
                <p class="text-black/40 text-[8px] font-bold tracking-[0.3em] mb-8 uppercase">ACE OF SPADES EDITION</p>
                <div class="nickname-area w-full px-4 space-y-4">
                    <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="8" class="w-full rounded-xl py-3 text-xs text-center font-bold outline-none transition-all">
                    <button onclick="goToModeSelection()" class="w-full btn-gold-start font-black text-sm py-4 rounded-xl shadow-xl active:scale-95 transition-all">ë ˆì´ìŠ¤ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mode-screen" class="hidden w-full max-w-4xl px-6 pt-24 pb-12 flex flex-col items-center">
        <h2 class="text-2xl md:text-3xl font-black text-white italic tracking-tighter mb-2">ëª¨ë“œ ì„ íƒ</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 w-full max-w-sm md:max-w-none">
            <div onclick="selectMode('ai')" class="mode-card p-6 md:p-8 rounded-3xl text-center">
                <div class="text-3xl mb-4">ğŸ¤–</div>
                <h3 class="text-lg font-black text-amber-400">ì¸ê³µì§€ëŠ¥ ëª¨ë“œ</h3>
                <p class="text-[9px] text-white/40 mb-4">ì •í†µ ë³´ë“œ ë ˆì´ìŠ¤</p>
            </div>
            <div onclick="selectMode('battle')" class="mode-card p-6 md:p-8 rounded-3xl text-center">
                <div class="text-3xl mb-4">âš”ï¸</div>
                <h3 class="text-lg font-black text-emerald-400">ë§ˆë¸” ì „íˆ¬ ëª¨ë“œ</h3>
                <p class="text-[9px] text-white/40 mb-4">íŠ¹ìˆ˜ ì „íˆ¬ ì¹¸ ì¡´ì¬</p>
            </div>
            <div onclick="selectMode('multi')" class="mode-card p-6 md:p-8 rounded-3xl text-center">
                <div class="text-3xl mb-4">ğŸŒ</div>
                <h3 class="text-lg font-black text-blue-400">ëœë¤ ë§¤ì¹­</h3>
                <p class="text-[9px] text-white/40 mb-4">ì‹¤ì‹œê°„ ìœ ì € ëŒ€ê²°</p>
            </div>
        </div>
        <button onclick="logoutToHome()" class="mt-8 text-white/20 text-[10px] font-bold underline mb-10">ì²˜ìŒ í™”ë©´ìœ¼ë¡œ</button>
    </div>

    <div id="matching-overlay" class="fixed inset-0 bg-black/95 z-[1000] flex flex-col items-center justify-center hidden">
        <div class="matching-loader mb-10"></div>
        <h2 class="text-2xl font-black text-white italic animate-pulse">ì‹¤ì œ í”Œë ˆì´ì–´ ë§¤ì¹­ ì¤‘...</h2>
        <button onclick="cancelMatching()" class="mt-12 text-red-500 font-bold text-xs">ë§¤ì¹­ ì·¨ì†Œ</button>
    </div>

    <div id="game-screen" class="hidden w-full h-full relative">
        <div class="flex flex-col items-center justify-center w-screen h-screen pt-12">
            <div class="flex gap-2 sm:gap-4 mb-4">
                <div id="p-lap-card" class="compact-profile active-turn text-center">
                    <span class="text-[7px] text-amber-400 font-bold uppercase">ë‚´ ìœ„ì¹˜</span>
                    <div class="text-white font-black text-xs">LAP <span id="p-lap">1</span></div>
                </div>
                <div id="ai-lap-card" class="compact-profile text-center">
                    <span id="o-label" class="text-[7px] text-slate-400 font-bold uppercase">ìƒëŒ€ë°© ìœ„ì¹˜</span>
                    <div class="text-white font-black text-xs">LAP <span id="ai-lap">1</span></div>
                </div>
            </div>
            <div id="board-container" class="board-container">
                <div id="board" class="dice-board">
                    <div class="center-status-bubble">
                        <div id="game-status-text" class="status-content">ì¤€ë¹„ ì™„ë£Œ!</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="game-controls-mini">
            <button onclick="handleResignClick()" class="text-[8px] sm:text-[10px] font-bold text-red-500 border border-red-500/50 px-2 py-1 rounded-lg">ê¸°ê¶Œ</button>
            <div class="flex items-center gap-2">
                <button onclick="toggleModal('shop-modal')" class="w-8 h-8 sm:w-10 sm:h-10 bg-white/10 border border-white/20 rounded-xl flex items-center justify-center text-lg">ğŸ›’</button>
                <div id="dice-btn" class="dice-box" onclick="handleRoll()">?</div>
            </div>
            <div class="text-right">
                <div class="text-[8px] text-amber-400 font-black">POS</div>
                <div class="text-white font-black text-base italic"><span id="pos-display">00</span></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, deleteDoc, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chess-marble-racing';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firestoreUtils = { doc, setDoc, onSnapshot, collection, query, where, deleteDoc, getDocs, updateDoc };
        window.isAuthReady = false;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            if (user) {
                window.isAuthReady = true;
                saveUserData(user.uid);
            }
        });

        async function saveUserData(uid) {
            const nickname = localStorage.getItem('chess_nickname');
            if (!nickname) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_rankings', uid);
            await setDoc(userRef, {
                nickname: nickname,
                winRate: 100,
                score: 1000 + Math.floor(Math.random() * 500),
                lastActive: Date.now()
            }, { merge: true });
        }
    </script>

    <script>
        /* Security Controls */
        (function() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; }, false);
            document.onselectstart = function() { return false; };
            document.ondragstart = function() { return false; };
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123) { e.preventDefault(); return false; }
                if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) { e.preventDefault(); return false; }
                if (e.ctrlKey && e.keyCode === 85) { e.preventDefault(); return false; }
                if (e.ctrlKey && e.keyCode === 83) { e.preventDefault(); return false; }
            }, false);
            window.oncontextmenu = function(event) { event.preventDefault(); event.stopPropagation(); return false; };
        })();

        let gameState = { turn: 'player', isMoving: false, active: false, mode: 'ai', matchId: null };
        let player = { name: "ìµëª…", pos: 0, lap: 1, items: { shield: 0 } };
        let ai = { pos: 0, lap: 1, name: "ìƒëŒ€ë°©" };
        let battleCells = [];
        const GOAL_LAPS = 3;
        const penaltyCells = [4, 11, 18];
        const bonusCells = [7, 14, 21];
        const path = [[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[6,5],[6,4],[6,3],[6,2],[6,1],[6,0],[5,0],[4,0],[3,0],[2,0],[1,0]];
        const chessIcons = {
            p: `<svg class="chess-svg" viewBox="0 0 100 100"><defs><linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fde68a" /><stop offset="50%" style="stop-color:#fbbf24" /><stop offset="100%" style="stop-color:#b45309" /></linearGradient></defs><path d="M50 10 L40 25 L60 25 Z" fill="url(#goldGrad)" /><rect x="35" y="25" width="30" height="10" rx="2" fill="url(#goldGrad)" /><path d="M40 35 L35 80 L65 80 L60 35 Z" fill="url(#goldGrad)" /><rect x="30" y="80" width="40" height="10" rx="3" fill="url(#goldGrad)" /></svg>`,
            ai: `<svg class="chess-svg" viewBox="0 0 100 100"><defs><linearGradient id="silverGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f8fafc" /><stop offset="50%" style="stop-color:#94a3b8" /><stop offset="100%" style="stop-color:#475569" /></linearGradient></defs><path d="M30 80 C 30 50, 40 30, 70 30 L 70 50 C 50 50, 45 60, 45 80 Z" fill="url(#silverGrad)" /><path d="M70 30 L 60 15 L 45 25 L 55 35 Z" fill="url(#silverGrad)" /><rect x="30" y="80" width="45" height="10" rx="3" fill="url(#silverGrad)" /></svg>`
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type = 'sine', duration = 0.1) {
            try { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); } catch(e) {}
        }

        function toggleModal(id) { const m = document.getElementById(id); if (m) m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }

        function goToModeSelection() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (!nickname) return;
            player.name = nickname;
            localStorage.setItem('chess_nickname', nickname);
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('mode-screen').classList.remove('hidden');
        }

        function logoutToHome() {
            document.getElementById('mode-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
        }

        function selectMode(mode) {
            gameState.mode = mode;
            if (mode === 'multi') startRealMatching(); else startGame();
        }

        async function startRealMatching() {
            if (!window.isAuthReady) return;
            document.getElementById('matching-overlay').classList.remove('hidden');
            const { collection, getDocs, setDoc, doc, onSnapshot, deleteDoc } = window.firestoreUtils;
            const db = window.db; const appId = window.appId; const uid = window.currentUser.uid;
            const waitRef = collection(db, 'artifacts', appId, 'public', 'data', 'matchmaking');
            const snapshot = await getDocs(waitRef);
            let targetMatch = null;
            snapshot.forEach(d => { if (d.id !== uid) targetMatch = { id: d.id, ...d.data() }; });
            if (targetMatch) {
                gameState.matchId = targetMatch.id;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchmaking', targetMatch.id));
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'active_matches', gameState.matchId), { player1: targetMatch.id, player2: uid, status: 'started' });
                startGame();
            } else {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchmaking', uid), { name: player.name, timestamp: Date.now() });
                let matchUnsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'active_matches', uid), (docSnap) => { if (docSnap.exists() && docSnap.data().status === 'started') { gameState.matchId = uid; matchUnsubscribe(); startGame(); } });
            }
        }

        function cancelMatching() {
            const { doc, deleteDoc } = window.firestoreUtils;
            deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'matchmaking', window.currentUser.uid));
            document.getElementById('matching-overlay').classList.add('hidden');
        }

        function startGame() {
            document.getElementById('matching-overlay').classList.add('hidden');
            player.pos = 0; player.lap = 1; ai.pos = 0; ai.lap = 1;
            gameState.turn = 'player'; gameState.isMoving = false; gameState.active = true;
            
            // Battle Mode Setup
            battleCells = [];
            if(gameState.mode === 'battle') {
                while(battleCells.length < 3) {
                    let r = Math.floor(Math.random() * (path.length - 2)) + 1;
                    if(!penaltyCells.includes(r) && !bonusCells.includes(r) && !battleCells.includes(r)) {
                        battleCells.push(r);
                    }
                }
            }

            document.getElementById('mode-screen').classList.add('hidden');
            document.getElementById('top-nav').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-dashboard').style.display = 'block';
            initBoard();
        }

        function handleResign() {
            gameState.active = false;
            if(document.getElementById('resign-modal').style.display === 'flex') toggleModal('resign-modal');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-dashboard').style.display = 'none';
            document.getElementById('top-nav').classList.remove('hidden');
            document.getElementById('mode-screen').classList.remove('hidden');
        }

        function initBoard() {
            const b = document.getElementById('board'); 
            b.innerHTML = '<div class="center-status-bubble"><div id="game-status-text" class="status-content">ì¤€ë¹„ ì™„ë£Œ!</div></div>';
            for(let r=0; r<7; r++) { 
                for(let c=0; c<7; c++) { 
                    const t = document.createElement('div'); 
                    t.style.gridArea = `${r+1}/${c+1}`; 
                    t.className = (r >= 2 && r <= 4 && c >= 2 && c <= 4) ? 'tile empty-space' : 'tile'; 
                    t.id = `c-${r}-${c}`; 
                    b.appendChild(t); 
                } 
            }
            path.forEach((p, i) => { 
                const el = document.getElementById(`c-${p[0]}-${p[1]}`); 
                if(el) { 
                    el.id = `tile-${i}`; 
                    el.innerText = i === 0 ? "START" : i; 
                    if(penaltyCells.includes(i)) el.classList.add('tile-penalty'); 
                    if(bonusCells.includes(i)) el.classList.add('tile-bonus'); 
                    if(battleCells.includes(i)) {
                        el.classList.add('tile-battle');
                        el.innerText = "âš”ï¸";
                    }
                } 
            });
            updateUI();
        }

        async function rollVisualDice() {
            const overlay = document.getElementById('dice-overlay'); const cube = document.getElementById('cube'); overlay.style.display = 'flex'; cube.classList.add('rolling');
            const val = Math.floor(Math.random() * 6) + 1; await new Promise(r => setTimeout(r, 600)); cube.classList.remove('rolling'); overlay.style.display = 'none'; return val;
        }

        async function handleRoll() {
            if(gameState.isMoving || gameState.turn !== 'player' || !gameState.active) return;
            await executeTurn('player');
            if(gameState.active && gameState.turn === 'ai') { await new Promise(r => setTimeout(r, 800)); await executeTurn('ai'); }
        }

        async function executeTurn(type) {
            if(!gameState.active) return; gameState.isMoving = true; updateUI();
            const target = type === 'player' ? player : ai;
            const opponent = type === 'player' ? ai : player;
            const dice = await rollVisualDice(); document.getElementById('dice-btn').innerText = dice;
            
            for(let i=0; i<dice; i++) {
                if(!gameState.active) return;
                const old = target.pos; target.pos = (target.pos + 1) % path.length;
                if (old > target.pos) { target.lap++; if (target.lap > GOAL_LAPS) { handleResign(); return; } }
                await movePieceVisual(type === 'player' ? 'player-piece' : 'ai-piece', target.pos);
            }
            
            if(!gameState.active) return;

            // Battle Logic: 1 step back for opponent
            if(battleCells.includes(target.pos)) {
                showStatusBubble("âš”ï¸ ì „íˆ¬ ë°œë°œ! ìƒëŒ€ë¥¼ 1ì¹¸ ë’¤ë¡œ!");
                opponent.pos = (opponent.pos - 1 + path.length) % path.length;
                await movePieceVisual(type === 'player' ? 'ai-piece' : 'player-piece', opponent.pos);
            }
            
            if(penaltyCells.includes(target.pos)) {
                if(type === 'player' && player.items.shield > 0) { player.items.shield--; }
                else { for(let j=0; j<2; j++) { target.pos = (target.pos - 1 + path.length) % path.length; await movePieceVisual(type === 'player' ? 'player-piece' : 'ai-piece', target.pos); } }
            } else if(bonusCells.includes(target.pos)) {
                target.pos = (target.pos + 2) % path.length; await movePieceVisual(type === 'player' ? 'player-piece' : 'ai-piece', target.pos);
            }
            
            if(gameState.active) { gameState.turn = type === 'player' ? 'ai' : 'player'; gameState.isMoving = false; updateUI(); }
        }

        function showStatusBubble(txt) {
            const el = document.getElementById('game-status-text');
            el.innerText = txt;
            el.classList.add('animate-bounce');
            setTimeout(() => el.classList.remove('animate-bounce'), 2000);
        }

        async function movePieceVisual(id, pos) { const p = document.getElementById(id); const t = document.getElementById(`tile-${pos}`); if (p && t) { t.appendChild(p); playSfx(400 + (pos * 10)); await new Promise(r => setTimeout(r, 200)); } }
        
        function updateUI() {
            if(!gameState.active) return;
            document.getElementById('db-name').innerText = player.name;
            document.getElementById('p-lap').innerText = player.lap;
            document.getElementById('ai-lap').innerText = ai.lap;
            document.getElementById('pos-display').innerText = (gameState.turn === 'player' ? player.pos : ai.pos).toString().padStart(2, '0');
            
            // Dashboard Mode Display Update
            const modeBadge = document.getElementById('db-mode-badge');
            const modeText = document.getElementById('db-mode-text');
            if (gameState.mode === 'battle') {
                modeBadge.innerText = 'BATTLE';
                modeText.innerText = 'ì „íˆ¬ ëª¨ë“œ';
                modeText.className = 'db-value text-emerald-400';
            } else if (gameState.mode === 'multi') {
                modeBadge.innerText = 'ONLINE';
                modeText.innerText = 'ì‹¤ì‹œê°„ ë§¤ì¹­';
                modeText.className = 'db-value text-blue-400';
            } else {
                modeBadge.innerText = 'CLASSIC';
                modeText.innerText = 'ì¸ê³µì§€ëŠ¥';
                modeText.className = 'db-value text-amber-400';
            }

            const inv = document.getElementById('db-inventory'); inv.innerHTML = '';
            if(player.items.shield > 0) inv.innerHTML += `<div class="item-badge">ğŸ›¡ï¸<span class="item-count">${player.items.shield}</span></div>`;
            renderPieces();
            const status = document.getElementById('game-status-text');
            status.innerText = gameState.turn === 'player' ? "ë‹¹ì‹ ì˜ ì°¨ë¡€!" : "ìƒëŒ€ë°©ì˜ ì°¨ë¡€...";
        }

        function renderPieces() { document.querySelectorAll('.chess-piece').forEach(e => e.remove()); renderPieceAt(player.pos, 'p', 'player-piece'); renderPieceAt(ai.pos, 'ai', 'ai-piece'); }
        function renderPieceAt(pos, type, id) { const tile = document.getElementById(`tile-${pos}`); if(!tile) return; const piece = document.createElement('div'); piece.className = `chess-piece`; piece.id = id; piece.innerHTML = chessIcons[type]; tile.appendChild(piece); }
        function buyItem(type) { player.items[type]++; updateUI(); }
        function handleResignClick() { toggleModal('resign-modal'); }
        
        async function openRanking() {
            if (!window.isAuthReady) return;
            const list = document.getElementById('ranking-list'); 
            list.innerHTML = '<div class="text-center py-10 animate-pulse text-amber-400 font-black">ë­í‚¹ ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>';
            toggleModal('ranking-modal');
            
            try {
                const { collection, getDocs, query } = window.firestoreUtils;
                const db = window.db; const appId = window.appId;
                const userRankingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_rankings');
                const q = query(userRankingsRef);
                const querySnapshot = await getDocs(q);
                
                let combinedData = [];
                querySnapshot.forEach((doc) => { combinedData.push({ id: doc.id, ...doc.data() }); });
                
                const prefixes = ["í™©ê¸ˆ", "ì „ì„¤ì˜", "ë‚ ìŒ˜", "ê³ ë…í•œ", "ê°•ë ¥í•œ", "ì‹ ë¹„ë¡œìš´", "ì–´ë‘ ì˜", "ë¹›ì˜", "ë¶ˆë©¸ì˜", "ê¶ê·¹ì˜"];
                const suffixes = ["ì²´ìŠ¤ì™•", "ë ˆì´ì„œ", "ë§ˆìŠ¤í„°", "ê¸°ì‚¬", "ë„ì „ì", "ì¥ì¸", "ìŠ¤í˜ì…œë¦¬ìŠ¤íŠ¸", "í”„ë¡œ", "í™©ì œ", "ì „ì‚¬"];
                
                while(combinedData.length < 400) {
                    const randomNick = prefixes[Math.floor(Math.random() * prefixes.length)] + " " + suffixes[Math.floor(Math.random() * suffixes.length)] + (Math.floor(Math.random() * 900) + 100);
                    combinedData.push({
                        nickname: randomNick,
                        winRate: Math.floor(Math.random() * 40) + 40,
                        score: Math.floor(Math.random() * 800) + 100,
                        isAI: true
                    });
                }
                
                combinedData.sort((a, b) => b.score - a.score);
                
                list.innerHTML = '';
                combinedData.slice(0, 400).forEach((data, i) => {
                    const rank = i + 1;
                    let tierClass = "tier-bronze";
                    let tierName = "BRONZE";
                    
                    if(rank <= 10) { tierClass = "tier-diamond"; tierName = "DIAMOND"; }
                    else if(rank <= 50) { tierClass = "tier-gold"; tierName = "GOLD"; }
                    else if(rank <= 150) { tierClass = "tier-silver"; tierName = "SILVER"; }
                    
                    const item = document.createElement('div');
                    item.className = 'ranking-item';
                    if (window.currentUser && data.id === window.currentUser.uid) {
                        item.style.borderColor = "#fbbf24";
                        item.style.background = "rgba(251, 191, 36, 0.15)";
                    }
                    
                    item.innerHTML = `
                        <div class="ranking-rank ${rank <= 3 ? 'text-amber-400 font-black' : 'text-white/40'}">#${rank}</div>
                        <div class="ranking-tier-cell"><span class="ranking-tier-badge ${tierClass}">${tierName}</span></div>
                        <div class="ranking-name text-white truncate pr-2 font-bold">${data.nickname}</div>
                        <div class="ranking-winrate text-[9px] text-white/60">${data.winRate}%</div>
                        <div class="ranking-score text-right font-black text-amber-400">${data.score.toLocaleString()}</div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error("Ranking fetch error:", error);
                list.innerHTML = '<div class="text-center py-10 text-red-500 font-bold">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
    </script>
</body>
</html>
